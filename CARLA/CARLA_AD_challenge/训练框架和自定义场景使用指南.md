# 训练框架使用

训练框架由challenge_evaluator_s2e + RLagent + 算法三部分组成  
使用时下载一个scenario_runner-0.9.5  
将challenge_evaluator_s2e.py 放入srunner/challenge/下  
将 RL_agent.py 放入srunner/challenge/autoahents下  
srunner/challenge/下新建一个algorithm文件夹放你要测试的算法 比如dqn.py  

测试方法
1、打开一个终端，打开carla server  
`cd CARLA_0.9.5`
`./CarlaUE4.sh`

2、打开另一个终端开RL Agent训练框架（文件路径替换一下）  
切换到虚拟环境（如果需要的话）  
`conda activate carla_env`  
`cd scenario_runner-0.9.5`  
手动添加路径  
```
export CARLA_ROOT=/你的CARLA路径/CARLA_0.9.5  
export ROOT_SCENARIO_RUNNER=`pwd`  
export PYTHONPATH=$PYTHONPATH:${CARLA_ROOT}/PythonAPI/carla/:${ROOT_SCENARIO_RUNNER}:`pwd`:${CARLA_ROOT}/PythonAPI/carla/dist/carla-0.9.5-py3.5-linux-x86_64.egg:${CARLA_ROOT}/PythonAPI/carla/agents\"
```

具体测试指令需要指定起点和终点，可参考以Town3下两个例子
# 直道  
```
python srunner/challenge/challenge_evaluator_s2e.py \
--map="Town03" \
--starting="-39.87355041503906_207.63058471679688_0.0_0_0_0" \
--ending="47.5295295715332_207.41250610351562_0.0_0_0_0"  
```

# 直道加左转  
```
python srunner/challenge/challenge_evaluator_s2e.py \
--map="Town03" \
--starting="-39.87355041503906_207.63058471679688_0.0_0_0_0" \
--ending="161.556396484375_206.8970947265625_0.0_0_0_0"
```

# 注意：
如需更改RL训练框架的Episode终止条件，如行驶到行人道、错误方向等提前终止
需要自行去scenariomanager文件夹下的atomic_scenario_criteria.py的各个函数中去
把terminate_on_failure属性改为TRUE 初始默认为FALSE
另外如需增加判断终止条件同样要加入到atomic_scenario_criteria.py中并把判断条件加入到场景行为树下，例子如下：

该函数为master_scenario的所有判断条件

 def _create_test_criteria(self):
        if isinstance(self.target, TargetConfiguration):
            location = self.target.transform.location
        else:
            location = self.target.location

        if isinstance(self.route, RouteConfiguration):
            route = self.route.data
        else:
            route = self.route

        collision_criterion = CollisionTest(self.ego_vehicle, terminate_on_failure=True)

        route_criterion = InRouteTest(self.ego_vehicle,
                                      radius=30.0,
                                      route=route,
                                      offroad_max=20,
                                      terminate_on_failure=True)

        completion_criterion = RouteCompletionTest(self.ego_vehicle, route=route)

        wrong_way_criterion = WrongLaneTest(self.ego_vehicle)

        onsidewalk_criterion = OnSidewalkTest(self.ego_vehicle)

        red_light_criterion = RunningRedLightTest(self.ego_vehicle)

        stop_criterion = RunningStopTest(self.ego_vehicle)

        parallel_criteria = py_trees.composites.Parallel("group_criteria",
                                                         policy=py_trees.common.ParallelPolicy.SUCCESS_ON_ONE)

        parallel_criteria.add_child(completion_criterion)
        parallel_criteria.add_child(collision_criterion)
        parallel_criteria.add_child(route_criterion)
        parallel_criteria.add_child(wrong_way_criterion)
        parallel_criteria.add_child(onsidewalk_criterion)
        parallel_criteria.add_child(red_light_criterion)
        parallel_criteria.add_child(stop_criterion)

        return parallel_criteria

# 自定义场景
场景包括交通信号灯、背景车流以及自定义（也包括挑战赛的十个基本场景scenario 1~10)
交通信号场景trafficlight_scenario和背景车流basic_scenario只需初始化加载并放入训练框架下的self.list_scenarios集合中即可

十个基本场景和自定义场景需要设置触发位置，触发位置设置写道user_scenario.json文件中，格式必须按样板写

# 简单的自定义场景构建方法
利用十个基本场景 + 红绿灯 + 背景车流自己调节参数进行组合
举例如构建强迫超车换道的方法：
用follow_leading_vehicle场景设置前车速度（一个小值） + 后车为RL智能体 + 周围背景车流场景
通过限制场景结束时间来强迫后车超车换道
